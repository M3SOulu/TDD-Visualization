<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->

<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Zorro Episode Visualization</title>
  <style>
    .axis path,
    .axis line {
      fill: none;
      stroke: red;
      shape-rendering: crispEdges;
    }

    .axis text {
      font-family: sans-serif;
      font-size: 11px;
    }
  </style>
  <script src="//d3js.org/d3.v3.min.js" charset="utf-8"></script>
  <script src="Counter.js"></script>
</head>

<body>
  <script type="text/javascript">
    var dataset = [
      [5, "testLast", "58%"],
      [10, "testFirst"],
      [15, "testAddition"],
      [20, "testLast"],
      [21, "codeProduction"],
      [25, "refactor"],
      [26, "testLast"],
      [28, "codeProduction"],
      [30, "testLast"],
      [31, "refactor"],
      [32, "regression"],
      [34, "refactor"],
      [38, "regression"],
      [40, "testFirst"],
      [42, "testLast"],
      [45, "testAddition"],
      [46, "refactor"],
      [47, "codeProduction"],
      [49, "refactor"],
      [50, "testFirst"]
    ];
    var informations = [
      ["Data Coverage: 54%", 1],
      ["Number of actions: 65", 2],
      ["Time Taken: 122", 3],
      ["Passing Tests: 2", 4],
      ["Failing Tests: 0", 5]
    ];
    
    var url = "http://localhost:3000/db";
    var json = "firstJSON.json";
    var xmlHttp = new XMLHttpRequest();
    var svgHeigth = 400;
    var svgWidth = 1000;
    var padding = 30;
    var previousWidth = 0;
    var barPadding = 40;
    var svg = d3.select("body")
      .append("svg")
      .attr("width", svgWidth)
      .attr("height", svgHeigth);
    var svgInfo = d3.select("body")
      .append("svg")
      .attr("width", svgWidth - 300)
      .attr("height", svgHeigth);
    var legend = d3.select("body")
      .append("svg")
      .attr("width", svgWidth - 500)
      .attr("height", svgHeigth);
    var xScale = d3.scale.linear()
      .domain([0, 240])
      .range([5, 965]);
    var yScale = d3.scale.linear()
      .domain([100, 0])
      .range([0, 360]);
    var xAxis = d3.svg.axis()
      .scale(xScale)
      .orient("bottom")
      .ticks(20);
    var yAxis = d3.svg.axis()
      .scale(yScale)
      .orient("left")
      .ticks(20);
               
      svg.append("g")
        .attr("class", "axis")
        .attr("transform", "translate(25," + (svgHeigth - padding + 5) + ")")
        .call(xAxis);
      svg.append("g")
        .attr("class", "axis")
        .attr("transform", "translate(" + padding + ",14)")
        .call(yAxis);
    function newData(){
        d3.json(url, function(error, data) {
            data.forEach(function(d) {
                d.duration = d.Duration;
                d.action = d.Action;
            });
            render(data);
        })
    };
     function render(data){

      svg.selectAll("rect")
        .data(data)
        .enter()
        .append("rect")
        .attr("x", function(d, i) {

          return (i * 23) + (d.duration/6); //TODO: replace 30 with the width of the bar
        })
        .attr("y", function(d) {

          return svgHeigth - (d.duration/3) - 25;
        })
        .attr("width", function(d) {
          return  d.duration/6;
        })
        .attr("height", function(d) {
          return d.duration / 3;

        })
        .attr("fill", function(d) {
          if (d.Action === "testLast") {
            color = "rgb(204,0,0)";
            counter.addTestLast();
            return "rgb(204, 0, 0)";
          } else if (d.Action === "test-first") {
            color = "rgb(0, 204, 0)";
            return "rgb(0, 204, 0)";
          } else if (d.Action === "test-addition")
            return "rgb(204, 0, 204)";
          else if (d.Action === "regression")
            return "rgb(204, 204, 0)";
          else if (d.Action === "codeProduction")
            return "rgb(204, 102, 0)";
          else
            return "rgb(0, 0, 204)";
        })
        .on("click", function() {
          svgInfo.selectAll("text")
            .data(informations)
            .enter()
            .append("text")
            .text(function(d) {
              return d[0];
            })
            .attr("y", function(d) {
              return d[1] * 70;
            })
            .style("font-size", "25px");
        });
      svg.selectAll("text")
        .data(dataset)
        .enter()
        .append("text")
        .text(function(d) {
          return d;
        })
        .attr("x", function(d, i) {
          return i * (w / dataset.length);
        })
        .attr("y", function(d) {
          return h - (d * 4);
        });
    };
    // draw legend colored rectangles
    legend.selectAll('rect')
      .data(dataset)
      .enter()
      .append("rect")
      .attr("x", svgWidth - 965)
      .attr("y", function(d) {
        if (d[1] === "testLast")
          return 30;
        else if (d[1] === "testFirst")
          return 65;
        else if (d[1] === "testAddition")
          return 100;
        else if (d[1] === "regression")
          return 135;
        else if (d[1] === "codeProduction")
          return 170;
        else
          return 205;
      })
      .attr("width", 30)
      .attr("height", 30)
      .style("fill", function(d) {
        if (d[1] === "testLast") {
          color = "rgb(204,0,0)";
          return "rgb(204, 0, 0)";
        } else if (d[1] === "testFirst") {
          color = "rgb(0, 204, 0)";
          return "rgb(0, 204, 0)";
        } else if (d[1] === "testAddition")
          return "rgb(204, 0, 204)";
        else if (d[1] === "regression")
          return "rgb(204, 204, 0)";
        else if (d[1] === "codeProduction")
          return "rgb(204, 102, 0)";
        else
          return "rgb(0, 0, 204)";
      });
    legend.selectAll('text')
      .data(dataset)
      .enter()
      .append("text")
      .text(function(d) {
        return d[1];
      })
      .attr("x", 100)
      .attr("y", function(d) {
        if (d[1] === "testLast")
          return 50;
        else if (d[1] === "testFirst")
          return 85;
        else if (d[1] === "testAddition")
          return 120;
        else if (d[1] === "regression")
          return 155;
        else if (d[1] === "codeProduction")
          return 190;
        else
          return 225;
      })
      .style("font-size", "25px");
    newData();


    setInterval(newData, 2000);
  </script>
</body>

</html>

